---
title: "Comparison of Extraction Methods (proteins)"
subtitle: "Thorax"
author:
    - Thomas Naake^[European Molecular Biology Laboratory, Meyerhofstrasse 1, 69117 Heidelberg, Germany]
fig_width: 15
fig_height: 10
fontsize: 12pt
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: TRUE
    theme: united
    number_sections: true
    highlight: tango
---

```{r env, include=FALSE, echo=FALSE, cache=FALSE}
library("knitr")
library("ggplot2")
knitr::opts_chunk$set(stop_on_error = 1L, fig.pos = "ht", dev = "png")
suppressPackageStartupMessages(library("wesanderson"))
suppressPackageStartupMessages(library("MatrixQCvis"))
suppressPackageStartupMessages(library("MatrixQCvisUtils"))
suppressPackageStartupMessages(library("PhysicoChemicalPropertiesProtein"))
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("limma"))
library("ggbeeswarm")
knitr::opts_knit$set(root.dir = "~/GitLab/20211202_extraction_method/")
```

# Load data 

```{r load_data}
se <- maxQuant("proteinGroups_thorax.xlsx", intensity = "LFQ", type = "xlsx", 
    sheet = "filtered")
## load annotation
cD <- openxlsx::read.xlsx("proteinGroups_thorax.xlsx", sheet = "annotation_filtered")
cD[, "Sample_IDs"] <- make.names(cD[, "Sample_IDs"])
colnames(cD)[colnames(cD) == "Sample_IDs"] <- "name"

## truncate se and write cD to colData(se)
se <- se[, cD$name]
se@colData <- cD %>% DataFrame()
colnames(se) <- se$name

## truncate colnames
colnames(se) <- stringr::str_replace(colnames(se), 
    "LFQ.intensity.1_KL_ProtMet_IO_40min_DDA_", "ProtMet_")
colnames(se) <- stringr::str_replace(colnames(se), 
    "LFQ.intensity.5_KL_nWorkFlow_IO_40min_DDA_", "nWorkFlow_")
colnames(se) <- stringr::str_replace(colnames(se), 
    "LFQ.intensity.5_KL_nWorkFlowt_IO_40min_DDA_", "nWorkFlow")

se$name <- colnames(se)
```

# QC

```{r shinyQC, eval = FALSE}
shinyQC(se)
```

Exclude the following samples:
`ProtMet_8U04FR_NG_14_B10_1_6020`, `ProtMet_IJ17TV_NG_12_B8_1_6016`.

```{r exclude_samples}
se <- MatrixQCvis:::selectSampleSE(se, 
    selection = c("ProtMet_8U04FR_NG_14_B10_1_6020", "ProtMet_IJ17TV_NG_12_B8_1_6016"),
    mode = "exclude")
```

## Translate the protein IDs

Translate Uniprot into Symbol.

```{r, message=FALSE, warning=FALSE}
library("org.Hs.eg.db")
uniprots <- Rkeys(org.Hs.egUNIPROT)
dict <- AnnotationDbi::select(org.Hs.eg.db, uniprots, "SYMBOL", "UNIPROT")
uniprot <- dict$UNIPROT
symbol <- dict$SYMBOL
names(symbol) <- uniprot

## rename
rownames(se) <- unlist(lapply(rownames(se), 
    function(x) paste(symbol[strsplit(x, split = ";")[[1]]], collapse = ";")))

## remove the features that have no corresponding Symbol
exclude_pattern <- c("NA", "NA;NA", "NA;NA;NA", "NA;NA;NA;NA", 
    "NA;NA;NA;NA;NA", "NA;NA;NA;NA;NA;NA", "NA;NA;NA;NA;NA;NA;NA")
se <- se[!rownames(se) %in% exclude_pattern, ]
```

# Data Filtering, Transformation, and Imputation

Perform `log`-transformation on the data set.

```{r data_transformation}
## keep features with more than ca. 50% (18/35) measured values
se <- se[rowSums(!is.na(assay(se))) >= 18 , ]
dim(se)

## transformation and imputation
a <- assay(se)
a_t <- transformAssay(a, method = "log")
se <- MatrixQCvis:::updateSE(se = se, assay = a_t)

saveRDS(se, file = "SummarizedExperiment_extraction_method_cohort_proteomics.RDS")
```

# Run the linear model

```{r}
cD <- colData(se)
cD$Type_Processing <- paste(cD$Type, cD$Processing, sep = "_")
cD$Individual <- stringr::str_remove(cD$Pseudonym, pattern = "_NG|_TU")
design <- model.matrix(~ 0 + Type_Processing, data = cD)
colnames(design) <- make.names(colnames(design))
cor <- limma::duplicateCorrelation(assay(se), design, block=cD$Individual)
fit <- lmFit(object = assay(se), design = design, block = cD$Individual,
    correlation = cor$consensus)

## create contrasts
contrasts <- makeContrasts(
    autoSP3vsMTBE_SP3 = (Type_ProcessingTU_autoSP3 - Type_ProcessingNG_autoSP3)/2 -
        (Type_ProcessingTU_MTBE_SP3 - Type_ProcessingNG_MTBE_SP3)/2,
    TUvsNG = (Type_ProcessingTU_autoSP3 - Type_ProcessingTU_MTBE_SP3)/2 -
        (Type_ProcessingNG_autoSP3 - Type_ProcessingNG_MTBE_SP3)/2, ## identical to autoSP3vsMTBE_SP3 
    NG_autoSP3vsMTBE_SP3 = Type_ProcessingNG_autoSP3 - Type_ProcessingNG_MTBE_SP3,
    TU_autoSP3vsMTBE_SP3 = Type_ProcessingTU_autoSP3 - Type_ProcessingTU_MTBE_SP3,
    autoSP3 = Type_ProcessingTU_autoSP3 - Type_ProcessingNG_autoSP3,
    MTBE_SP3 = Type_ProcessingTU_MTBE_SP3 - Type_ProcessingNG_MTBE_SP3,
    levels = design)
fit_c <- contrasts.fit(fit, contrasts)
fit_eB <- eBayes(fit_c)

## set parameters for differential expression
num <- Inf
p_val <- 1
adj <- "BH"
```  


## autoSP3 vs. MTBE_SP3

We test here the DE proteins between NG and TU and compare the results that
we get from the two extraction methods. 

Ideally, this should result in few DE proteins. This would indicate that the 
methods yield similar results.

```{r autoSP3vsMTBE_SP3}
tT <- topTable(fit_eB, number = num, p.value = p_val, adjust.method = adj,
    coef = "autoSP3vsMTBE_SP3")
rmarkdown::paged_table(tT)
sum(tT[, "adj.P.Val"] < 0.05, na.rm = TRUE)
tT <- cbind(name = rownames(tT), tT)
volcanoPlot(tT)
tT_autoSP3vsMTBE <- tT

write.table(tT, file = "proteomics_DE_t_autoSP3vsMTBE_SP3.txt", 
    quote = FALSE, sep = "\t")
```

## autoSP3 vs. MTBE_SP3 (NG)

We test here the DE proteins from the two extraction methods looking only at 
NG. 

Ideally, this should result in few DE proteins. This would indicate that the 
methods yield similar results.

```{r NG_autoSP3vsMTBE_SP3}
tT <- topTable(fit_eB, number = num, p.value = p_val, adjust.method = adj,
    coef = "NG_autoSP3vsMTBE_SP3")
rmarkdown::paged_table(tT)
sum(tT[, "adj.P.Val"] < 0.05, na.rm = TRUE)
tT <- cbind(name = rownames(tT), tT)
volcanoPlot(tT)
tT_NG <- tT

write.table(tT, file = "proteomics_DE_t_NG_autoSP3vsMTBE_SP3.txt", 
    quote = FALSE, sep = "\t")
```


## autoSP3 vs. MTBE_SP3 (TU)

We test here the DE proteins from the two extraction methods looking only at 
TU 

Ideally, this should result in few DE proteins. This would indicate that the 
methods yield similar results.

```{r TU_autoSP3vsMTBE_SP3}
tT <- topTable(fit_eB, number = num, p.value = p_val, adjust.method = adj,
    coef = "TU_autoSP3vsMTBE_SP3")
rmarkdown::paged_table(tT)
sum(tT[, "adj.P.Val"] < 0.05, na.rm = TRUE)
tT <- cbind(name = rownames(tT), tT)
volcanoPlot(tT)
tT_TU <- tT

write.table(tT, file = "proteomics_DE_t_TU_autoSP3vsMTBE_SP3.txt", 
    quote = FALSE, sep = "\t")
```


Ok, this is interesting, when looking at the individual tissues, there are quite
many differences, but the differences "vanish" when we combine the different
conditions (autoSP3 vs. MTBE_SP3).

## Overlap between DE proteins

We will continue and check the overlap of DE proteins between the contrasts

    - autoSP3 vs. MTBE_SP3 (NG)
    - autoSP3 vs. MTBE_SP3 (TU)
    - autoSP3 vs. MTBE_SP3 (TU-NG)
    
```{r de_overlap_1}
## only continue with the significant ones
NG_sign <- tT_NG[tT_NG$adj.P.Val < 0.05 & !is.na(tT_NG$adj.P.Val), ]
dim(NG_sign)
TU_sign <- tT_TU[tT_TU$adj.P.Val < 0.05 & !is.na(tT_TU$adj.P.Val), ]
dim(TU_sign)
autoSP3vsMTBE_sign <- tT_autoSP3vsMTBE[tT_autoSP3vsMTBE$adj.P.Val < 0.05 & !is.na(tT_autoSP3vsMTBE$adj.P.Val), ]
dim(autoSP3vsMTBE_sign)

## create list
l <- list(NG = rownames(NG_sign), TU = rownames(TU_sign), 
    autoSP3vsMTBE_SP3 = rownames(autoSP3vsMTBE_sign))
UpSetR::upset(UpSetR::fromList(l), order.by = "freq")

pdf("UpSet_NAT_TT_autoSP3vsMTBESP3.pdf")
UpSetR::upset(UpSetR::fromList(l), order.by = "freq")
dev.off()
```


We will continue and check the overlap of DE proteins between the contrasts:
    
    - TU vs. NG (autoSP3)
    - TU vs. NG (MTBE_SP3)
    
```{r de_overlap}
## autoSP3
tT_autoSP3 <- topTable(fit_eB, number = num, p.value = p_val, adjust.method = adj,
    coef = "autoSP3")
sum(tT_autoSP3$adj.P.Val < 0.05, na.rm = TRUE)
tT_autoSP3 <- cbind(name = rownames(tT_autoSP3), tT_autoSP3)
volcanoPlot(tT_autoSP3)
write.table(tT_autoSP3, file = "proteomics_DE_t_TUvsNG_autoSP3.txt", 
    quote = FALSE, sep = "\t")

## MTBE_SP3
tT_MTBE_SP3 <- topTable(fit_eB, number = num, p.value = p_val, adjust.method = adj,
    coef = "MTBE_SP3")
rmarkdown::paged_table(tT_MTBE_SP3)
sum(tT_MTBE_SP3$adj.P.Val < 0.05, na.rm = TRUE)
tT_MTBE_SP3 <- cbind(name = rownames(tT_MTBE_SP3), tT_MTBE_SP3)
volcanoPlot(tT_MTBE_SP3)

write.table(tT_MTBE_SP3, file = "proteomics_DE_t_TUvsNG_MTBE_SP3.txt", 
    quote = FALSE, sep = "\t")

## only continue with the significant ones 
autoSP3_sign <- tT_autoSP3[tT_autoSP3$adj.P.Val < 0.05 & !is.na(tT_autoSP3$adj.P.Val), ]
MTBE_SP3_sign <- tT_MTBE_SP3[tT_MTBE_SP3$adj.P.Val < 0.05  & !is.na(tT_MTBE_SP3$adj.P.Val), ]

## create list
l <- list(autoSP3 = autoSP3_sign$ID, MTBE_SP3 = MTBE_SP3_sign$ID)
UpSetR::upset(UpSetR::fromList(l), order.by = "freq")

pdf("UpSet_NATvsTT_autoSP3_MTBESP3.pdf")
UpSetR::upset(UpSetR::fromList(l), order.by = "freq")
dev.off()

## Can we say anything about the magnitude of the difference? E.g. the
## overlapping 1004 proteins show on average a larger fold change than those
## detected by only one of the methods? Show in a box plot.
mtbe_auto_shared <- l$autoSP3[l$autoSP3 %in% l$MTBE_SP3]
mtbe_unique <- l$MTBE_SP3[!(l$MTBE_SP3 %in% l$autoSP3)]
auto_unique <- l$autoSP3[!(l$autoSP3 %in% l$MTBE_SP3)]

df_mtbe_shared <- data.frame(
    logFC = tT_MTBE_SP3[tT_MTBE_SP3$ID %in% mtbe_auto_shared, "logFC"],
    set = "shared", type = "MTBE-SP3")
df_auto_shared <- data.frame(
    logFC = tT_autoSP3[tT_autoSP3$ID %in% mtbe_auto_shared, "logFC"],
    set = "shared", type = "autoSP3")
df_mtbe_unique <- data.frame(
    logFC = tT_MTBE_SP3[tT_MTBE_SP3$ID %in% mtbe_unique, "logFC"],
    set = "unique", type = "MTBE-SP3")
df_auto_unique <- data.frame(
    logFC = tT_autoSP3[tT_autoSP3$ID %in% auto_unique, "logFC"],
    set = "unique", type = "autoSP3")
df_all <- rbind(df_mtbe_shared, df_auto_shared, df_mtbe_unique, df_auto_unique)

g <- ggplot(df_all) +
    geom_beeswarm(aes(y = logFC, x = type), size = 0.5, alpha = 0.5) +
    facet_wrap(~ set + type, ncol = 4, scales = "free_x") +
    theme_classic()
ggsave(filename = "BeeSwarm_NATvsTT_autoSP3_MTBESP3.pdf", plot = g)

df_tmp <- df_all
df_tmp$logFC <- abs(df_tmp$logFC)
wilcox.test(
    df_tmp[df_tmp$set == "shared" & df_tmp$type == "autoSP3", "logFC"],
    df_tmp[df_tmp$set == "unique" & df_tmp$type == "autoSP3", "logFC"],
    alternative = "greater")
wilcox.test(
    df_tmp[df_tmp$set == "shared" & df_tmp$type == "MTBE-SP3", "logFC"],
    df_tmp[df_tmp$set == "unique" & df_tmp$type == "MTBE-SP3", "logFC"],
    alternative = "greater")

## TU vs NG. (taking into account baseline autoSP3/MTBE-SP3)
tT <- topTable(fit_eB, number = num, p.value = p_val, adjust.method = adj,
    coef = "TUvsNG")
rmarkdown::paged_table(tT)
tT <- cbind(name = rownames(tT), tT)
volcanoPlot(tT)
tT_TUvsNG <- tT

## plot t-values
df <- data.frame(vals_x = tT_autoSP3[rownames(tT_autoSP3), "t"], 
        vals_y = tT_MTBE_SP3[rownames(tT_autoSP3), "t"],
        vals_z = tT_TUvsNG[rownames(tT_autoSP3), "t"])
rownames(df) <- rownames(tT_autoSP3)

## t-values(autoSP3) vs t-values (MTBE-SP3)
g <- ggplot(df, aes_string(x = "vals_x", y = "vals_y")) +
    geom_point(aes(alpha = 0.7)) +
    xlab("t-values (autoSP3)") + ylab("t-values (MTBE-SP3)") +
    ggpubr::stat_cor(method = "spearman", cor.coef.name = "rho") +
    ggtitle("NAT vs. TT") +
    theme_classic() +
    theme(legend.position = "none")
g 
ggsave(g, filename = "scatter_NATvsTT_autoSP3_MTBESP3.pdf")
cor.test(tT_autoSP3[rownames(tT_autoSP3), "t"],
    tT_MTBE_SP3[rownames(tT_autoSP3), "t"], method = "spearman")

## t-values(autoSP3) vs t-values (AutoSP3vsMTBE-SP3)
g <- ggplot(df, aes_string(x = "vals_x", y = "vals_z")) +
    geom_point(aes(alpha = 0.7)) +
    xlab("t-values (autoSP3)") + ylab("t-values (autoSP3/MTBE-SP3)") +
    ggpubr::stat_cor(method = "spearman", cor.coef.name = "rho") +
    ggtitle("NAT vs. TT") +
    theme_classic() +
    theme(legend.position = "none")
g 
ggsave(g, filename = "scatter_NATvsTT_autoSP3_autoSP3vsMTBESP3.pdf")

## t-values(MTBE-SP3) vs t-values (AutoSP3vsMTBE-SP3)
g <- ggplot(df, aes_string(x = "vals_y", y = "vals_z")) +
    geom_point(aes(alpha = 0.7)) +
    xlab("t-values (MTBE-SP3)") + ylab("t-values (autoSP3/MTBE-SP3)") +
    ggpubr::stat_cor(method = "spearman", cor.coef.name = "rho") +
    ggtitle("NAT vs. TT") +
    theme_classic() +
    theme(legend.position = "none")
g 
ggsave(g, filename = "scatter_NATvsTT_MTBESP3_autoSP3vsMTBESP3.pdf")
```



### GO enrichment analysis TU vs NG (autoSP3)

```{r go_fct, message=FALSE, warning=FALSE, echo = FALSE}
## load the packages
library("org.Hs.eg.db")

## define the significance level for enrichment
signProts <- function(allScore) {
   return(allScore <= 0.05)
}

## all takes the proteins into account with p < 0.05
## up takes the proteins into account with p < 0.05 AND t > 0
## down takes the proteins into account with p < 0.05 AND t < 0
enrichment <- function(tT, organism = "Hs", de = c("all", "up", "down")) {
    
    de <- match.arg(de)
    ## translate from UNIPROT into SYMBOL
    ## conversion between id's 
    if (organism == "Hs") {
        symbols <- Rkeys(org.Hs.egSYMBOL)
        dict <- AnnotationDbi::select(org.Hs.eg.db, symbols, "ENTREZID", "SYMBOL")
        species <- "Hs"
    }
    symbol <- dict$SYMBOL
    entrez <- dict$ENTREZID
    names(entrez) <- symbol
    
    ## some proteins have multiple symbol ids, only keep the first
    tT$ID <- unlist(lapply(strsplit(tT$ID, split = "[;]"), "[", 1))
    tT <- tT[!duplicated(tT$ID), ]
    rownames(tT) <- tT$ID
    
    ## translate into entrez
    tT_entrez <- as.character(entrez[rownames(tT)])
    tT <- tT[!is.na(tT_entrez), ]
    tT_entrez <- tT_entrez[!is.na(tT_entrez)]
    tT <- tT[!duplicated(tT_entrez), ]
    tT_entrez <- tT_entrez[!duplicated(tT_entrez)]
    rownames(tT) <- tT_entrez
    
    ## use the p-values from the raw-intensity derived values
    tT <- tT[!is.na(tT[, "adj.P.Val"]), ]
    
    if (de == "all") {
        tT_de <- tT[tT[, "adj.P.Val"] < 0.05, ]  
    }
    if (de == "up") {
        tT_de <- tT[tT[, "adj.P.Val"] < 0.05 & tT[, "t"] > 0, ]  
    }
    if (de == "down") {
        tT_de <- tT[tT[, "adj.P.Val"] < 0.05 & tT[, "t"] < 0, ]  
    }
    
    allRes <- goana(de = rownames(tT_de), 
          universe = rownames(tT), species = species)
    
    ## return the results
    allRes
}

plotGO <- function(go, xlab = "Biological Process", ylab = "-log10(p-value)", n = 20) {
    go$new_term <- go$Term
    #go$new_term <- paste(rownames(go), go$Term, sep = ",")
    go <- go[order(go$P.DE)[1:n], ]
    go <- go[go$P.DE < 0.05, ]
    go$new_term <- factor(x = go$new_term, levels = go$new_term[n:1])
    go <- go[!is.na(go$new_term), ]
    
    ggplot(go, aes(x = new_term, y = -log10(P.DE))) +
        stat_summary(geom = "bar", fun = "mean", position = "identity") +
        xlab(xlab) +
        ylab(ylab) +
        theme_classic() +
        theme(
            legend.position = 'none',
            axis.text.x = element_text(angle = 0, size = 10, hjust = 1.10),
            axis.text.y = element_text(angle = 0, size = 9, vjust = 0.5),
        axis.title = element_text(size = 12)) +
        guides(colour = guide_legend(override.aes = list(size = 2.5))) +
        coord_flip()
}
```

Run now the GO enrichment tests. Use the raw (unadjusted) values and return
the GO terms for the ontologies Biological Process (BP), Molecular Function (MF) 
and Cellular Component (CC). Perform a Fisher test with the significant features
($\alpha$ < 0.05).

For autoSP3.
```{r enrichment_cells_autoSP3, message=FALSE, warning=FALSE, echo = FALSE}
allRes <- enrichment(tT_autoSP3, organism = "Hs")

print("## BP")
bp <- topGO(allRes, ontology = "BP", number = num)
rmarkdown::paged_table(bp)
ggsave(plotGO(bp, xlab = "Biological Process"), file = "GO_TUvsNAT_autoSP3_BP.pdf")

print("## MF")
mf <- topGO(allRes, ontology = "MF", number = num)
rmarkdown::paged_table(mf)
ggsave(plotGO(mf, xlab = "Molecular Function"), file = "GO_TUvsNAT_autoSP3_MF.pdf")

print("## CC")
cc <- topGO(allRes, ontology = "CC", number = num)
rmarkdown::paged_table(cc)
ggsave(plotGO(cc, xlab = "Cellular Component"), file = "GO_TUvsNAT_autoSP3_CC.pdf")

## how many significant terms with "Mitochondria|mitochondria"?
.pattern = "Mitochondria|mitochondria|Glycolysis|glycolysis|Glycolytic|glycolytic|Tricarboxylic acid|tricarboxylic acid"
print("## BP mitochondria:")
bp_mito <- bp[grepl(bp$Term, pattern = .pattern) & bp$P.DE < 0.05, ]
nrow(bp_mito)
rmarkdown::paged_table(bp_mito)
ggsave(plotGO(bp_mito, xlab = "Biological Process"), file = "GO_TUvsNAT_autoSP3_mito_BP.pdf")

print("## MF mitochondria:")
mf_mito <- mf[grepl(mf$Term, pattern = .pattern) & mf$P.DE < 0.05, ]
nrow(mf_mito)
rmarkdown::paged_table(mf_mito)
ggsave(plotGO(mf_mito, xlab = "Molecular Function"), file = "GO_TUvsNAT_autoSP3_mito_MF.pdf")

print("## CC mitochondria:")
cc_mito <- cc[grepl(cc$Term, pattern = .pattern) & cc$P.DE < 0.05, ]
nrow(cc_mito)
rmarkdown::paged_table(cc_mito)
ggsave(plotGO(cc_mito, xlab = "Cellular Component"), file = "GO_TUvsNAT_autoSP3_mito_CC.pdf")
```

### GO enrichment analysis TU vs NG (MTBE-SP3)

Run now the GO enrichment tests. Use the raw (unadjusted) values and return
the GO terms for the ontologies Biological Process (BP), Molecular Function (MF) 
and Cellular Component (CC). Perform a Fisher test with the significant features
($\alpha$ < 0.05).

For MTBE-SP3. 
```{r enrichment_cells_MTBESP3, message=FALSE, warning=FALSE, echo = FALSE}
allRes <- enrichment(tT_MTBE_SP3, organism = "Hs")

print("## BP")
bp <- topGO(allRes, ontology = "BP", number = num)
rmarkdown::paged_table(bp)
ggsave(plotGO(bp, xlab = "Biological Process"), file = "GO_TUvsNAT_MTBESP3_BP.pdf")

print("## MF")
mf <- topGO(allRes, ontology = "MF", number = num)
rmarkdown::paged_table(mf)
ggsave(plotGO(mf, xlab = "Molecular Function"), file = "GO_TUvsNAT_MTBESP3_MF.pdf")

print("## CC")
cc <- topGO(allRes, ontology = "CC", number = num)
rmarkdown::paged_table(cc)
ggsave(plotGO(cc, xlab = "Cellular Component"), file = "GO_TUvsNAT_MTBESP3_CC.pdf")


## how many significant terms with "Mitochondria|mitochondria"?
.pattern = "Mitochondria|mitochondria|Glycolysis|glycolysis|Glycolytic|glycolytic|Tricarboxylic acid|tricarboxylic acid"
print("## BP mitochondria:")
bp_mito <- bp[grepl(bp$Term, pattern = .pattern) & bp$P.DE < 0.05, ]
nrow(bp_mito)
rmarkdown::paged_table(bp_mito)
ggsave(plotGO(bp_mito, xlab = "Biological Process"), file = "GO_TUvsNAT_MTBESP3_mito_BP.pdf")

print("## MF mitochondria:")
mf_mito <- mf[grepl(mf$Term, pattern = .pattern) & mf$P.DE < 0.05, ]
nrow(mf_mito)
rmarkdown::paged_table(mf_mito)
ggsave(plotGO(mf_mito, xlab = "Molecular Function"), file = "GO_TUvsNAT_MTBESP3_mito_MF.pdf")

print("## CC mitochondria:")
cc_mito <- cc[grepl(cc$Term, pattern = .pattern) & cc$P.DE < 0.05, ]
nrow(cc_mito)
rmarkdown::paged_table(cc_mito)
ggsave(plotGO(cc_mito, xlab = "Cellular Component"), file = "GO_TUvsNAT_MTBESP3_mito_CC.pdf")

```

## Individuals as covariates

```{r}
cD <- colData(se)
cD$Type_Processing <- paste(cD$Type, cD$Processing, sep = "_")
cD$Individual <- stringr::str_remove(cD$Pseudonym, pattern = "_NG|_TU")
design <- model.matrix(~ 0 + Type_Processing + Individual, data = cD)
fit <- lmFit(object = assay(se), design = design)

## create contrasts
contrasts <- makeContrasts(
    autoSP3 = Type_ProcessingTU_autoSP3 - Type_ProcessingNG_autoSP3,
    MTBE_SP3 = Type_ProcessingTU_MTBE_SP3 - Type_ProcessingNG_MTBE_SP3,
    levels = design)
fit_c <- contrasts.fit(fit, contrasts)
fit_eB <- eBayes(fit_c)

## set parameters for differential expression
num <- Inf
p_val <- 1
adj <- "BH"

## get the features for autoSP3
tT_autoSP3_covariate <- topTable(fit_eB, number = num, p.value = p_val, 
    adjust.method = adj, coef = "autoSP3")

cor(x = tT_autoSP3_covariate$t[order(rownames(tT_autoSP3_covariate))],
    y = tT_autoSP3$t[order(rownames(tT_autoSP3))], 
    use = "pairwise.complete.obs")

## get the features for MTBE_SP3
tT_MTBE_SP3_covariate <- topTable(fit_eB, number = num, p.value = p_val, 
    adjust.method = adj, coef = "MTBE_SP3")

cor(x = tT_MTBE_SP3_covariate$t[order(rownames(tT_MTBE_SP3_covariate))],
    y = tT_MTBE_SP3$t[order(rownames(tT_MTBE_SP3))], 
    use = "pairwise.complete.obs")
```


## Tissue-heterogeneity

We test here the effect of tissue heterogeneity within the 
autoSP3 and MTBE-SP3 samples. Therefore, we randomly select 50% of the
samples from within autoSP3 and MTBE-SP3 samples and run linear models 
within each extraction method.

In case of tissue heterogeneity, there should be some proteins that are 
differentially abundant.

```{r}
se$Patient_ID <- stringr::str_remove(se$Pseudonym, pattern = "_TU|_NG")

##
## MTBE-SP3
se_mtbesp3 <- se[, se$Processing == "MTBE_SP3"]
ids_mtbesp3 <- se_mtbesp3$Patient_ID |> unique()
set.seed(2023)
ids_group1 <- sample(ids_mtbesp3, size = floor(length(ids_mtbesp3)/ 2),
    replace = FALSE)
se_mtbesp3$random_group <- ifelse(se_mtbesp3$Patient_ID %in% ids_group1, "1", "2")

## run the linear model, adjust for the tissue effect
design <- model.matrix(~ 0 + random_group + Type, data = colData(se_mtbesp3))
colnames(design) <- make.names(colnames(design))
fit <- lmFit(object = assay(se_mtbesp3), design = design)

## make contrasts
contrasts <- makeContrasts(
    group1_vs_group2 = random_group1 - random_group2,
    levels = design)
fit_c <- contrasts.fit(fit, contrasts)
fit_eB <- eBayes(fit_c)

## get the features for MTBE-SP3
tT_MTBESP3 <- topTable(fit_eB, number = num, p.value = p_val, 
    adjust.method = adj)
sum(tT_MTBESP3[, "adj.P.Val"] < 0.05, na.rm = TRUE)
rmarkdown::paged_table(tT_MTBESP3)


##
## autoSP3
se_autosp3 <- se[, se$Processing == "autoSP3"]
ids_autosp3 <- se_autosp3$Patient_ID |> unique()
set.seed(2023)
ids_group1 <- sample(ids_autosp3, size = floor(length(ids_autosp3)/ 2), 
    replace = FALSE)
se_autosp3$random_group <- ifelse(se_autosp3$Patient_ID %in% ids_group1, "1", "2")

## run the linear model, adjust for the tissue effect
design <- model.matrix(~ 0 + random_group + Type , data = colData(se_autosp3))
colnames(design) <- make.names(colnames(design))
fit <- lmFit(object = assay(se_autosp3), design = design)

## make contrasts
contrasts <- makeContrasts(
    group1_vs_group2 = random_group1 - random_group2,
    levels = design)
fit_c <- contrasts.fit(fit, contrasts)
fit_eB <- eBayes(fit_c)

## get the features for MTBE-SP3
tT_autoSP3 <- topTable(fit_eB, number = num, p.value = p_val, 
    adjust.method = adj)
sum(tT_autoSP3[, "adj.P.Val"] < 0.05)
rmarkdown::paged_table(tT_autoSP3)

```